[uwsgi]
# Base configuration
chdir = /app
virtualenv = /dispatcharrpy
env = DJANGO_SETTINGS_MODULE=dispatcharr.settings

# TS Proxy specific - SINGLE PROCESS with async handling
master = true
module = dispatcharr.wsgi:application
processes = 1
workers = 1
threads = 2
enable-threads = true

# Add these async settings to handle many more connections
gevent = 100
async = 100
ugreen = true

# Listen on a dedicated port
http = 0.0.0.0:5657
http-keepalive = 1

# Optimize for streaming
http-timeout = 3600  # 1 hour streaming timeout
socket-timeout = 3600
harakiri = 3600
buffer-size = 262144  # 256KB buffer
post-buffering = 0    # Disable post buffering for streams
thunder-lock = true   # Process lock for better stability
so-keepalive = true   # Enable TCP keepalive

# Prevent auto-restart during streaming
max-requests = 0      # Don't restart after X requests
worker-reload-mercy = 30
ignore-sigpipe = true
ignore-write-errors = true
disable-write-exception = true

# Route handling - only handle proxy routes
route = ^/proxy/ continue:
route = .* break:404