FROM ubuntu:24.04

ENV DEBIAN_FRONTEND=noninteractive
ENV VIRTUAL_ENV=/dispatcharrpy
ENV PATH="$VIRTUAL_ENV/bin:$PATH"

# Install system dependencies
RUN apt-get update && apt-get install -y \
    software-properties-common curl gnupg2 wget lsb-release \
    build-essential gcc libpcre3 libpcre3-dev python3.13 python3.13-venv python3.13-dev \
    nginx redis-server libpq-dev procps streamlink \
    libva-drm2 libva-x11-2 libva-dev libva-wayland2 \
    i965-va-driver intel-media-va-driver mesa-va-drivers \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# Create virtual environment
RUN python3.13 -m venv $VIRTUAL_ENV && pip install --upgrade pip

# Install Python deps (expect these to be cached)
COPY requirements.txt /tmp/requirements.txt
RUN pip install --no-cache-dir -r /tmp/requirements.txt && rm /tmp/requirements.txt

# Add FFmpeg binaries
COPY --from=lscr.io/linuxserver/ffmpeg:latest /usr/local/bin/ffmpeg /usr/local/bin/ffmpeg
COPY --from=lscr.io/linuxserver/ffmpeg:latest /usr/local/bin/ffprobe /usr/local/bin/ffprobe
COPY --from=lscr.io/linuxserver/ffmpeg:latest /usr/local/lib/ /usr/local/lib/